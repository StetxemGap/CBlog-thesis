<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8"/>
        <title>Профиль</title>
        <link rel="stylesheet" th:href="@{/style/profileStyle.css}" />
        <link rel="stylesheet" th:href="@{/style/style.css}" />
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Jura:wght@300..700&family=Montserrat+Alternates:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    </head>

    <body>
        <div class="container">

            <div th:replace="~{staticElement :: navbar}">

            </div>

            <div th:replace="~{staticElement :: sidebar}">

            </div>

            <div class="mainContentContainer">
                <div id="currentUser" th:data-username="${profile.username}" style="display: none;"></div>
                    <div class="profileCard">
                        <div id="profileImage" class="profileImage">
                            <img th:if="${profile.photoPath != null}"
                            th:src="@{'/uploads/' + ${profile.photoPath}}">
                            <img th:unless="${profile.photoPath != null}" th:src="@{/img/user.png}">
                        </div>

                        <div class="about">
                            <h3 th:text="${profile.lastName} + ' ' + ${profile.firstName}"></h3>

                            <p  th:text="${profile.position}">
                        </div>
                    </div>

                    <div class="mainInfo">
                        <h3>Основная информация</h3>
                        <div class="staticData">
                            <p>Имя</p>
                            <p>Фамилия</p>
                            <p>Дата рождения</p>
                            <p>Пол</p>
                        </div>
                        
                        <div class="dynamicData">
                            <p th:text="${profile.firstName}">

                            <p th:text="${profile.lastName}">

                            <p th:if="${profile.dob != null}"
                               th:text="${#temporals.format(profile.dob, 'dd.MM.yyyy')}">
                            <p th:unless="${profile.dob != null}">------</p>

                            <p th:text="${!profile.gender.isEmpty()} ? ${profile.gender} : '------'"></p>
                        </div>
                    </div>

                    <div class="workplaceInfo">
                        <h3>Рабочее место</h3>
                        <div class="staticData">
                            <p>Город</p>
                            <p>Улица</p>
                            <p>Этаж</p>
                            <p>Кабинет</p>
                        </div>
                        
                        <div class="dynamicData">
                            <p th:text="${profile.city}"></p>

                            <p th:text="${!profile.street.isEmpty()} ? ${profile.street} : '------'"></p>

                            <p th:text="${!profile.officeFloor.isEmpty()} ? ${profile.officeFloor} : '------'"></p>

                            <p th:text="${!profile.officeNumber.isEmpty()} ? ${profile.officeNumber} : '------'"></p>
                        </div>

                    </div>

                    <div class="feedback">
                        <h3>Связь со мной</h3>
                    </div>
            </div>
        </div>

    <script>
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);
        const element = document.getElementById('currentUser');
        const username = element.getAttribute('data-username');

        stompClient.connect({}, () => {
            stompClient.send("/app/register", {}, username);

            stompClient.subscribe('/topic/onlineStatus', (message) => {
                const data = JSON.parse(message.body);
                if (data.username === username) {
                    const element = document.getElementById('profileImage');
                    element.className = data.isOnline ? 'profileImage online' : 'profileImage offline';
                }
            });
        });

        window.addEventListener('beforeunload', () => {
            stompClient.send("/app/unregister", {}, username);
        });
    </script>
    </body>
</html>